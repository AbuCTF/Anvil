services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: anvil-postgres
    environment:
      POSTGRES_USER: anvil
      POSTGRES_PASSWORD: anvil
      POSTGRES_DB: anvil
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U anvil -d anvil"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - anvil-internal

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: anvil-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - anvil-internal

  # Anvil Backend API
  api:
    build:
      context: .
      dockerfile: deployments/docker/Dockerfile.api
    container_name: anvil-api
    user: root  # Required for Docker socket access
    environment:
      - ANVIL_ENV=development
      - ANVIL_DATABASE_HOST=postgres
      - ANVIL_DATABASE_PORT=5432
      - ANVIL_DATABASE_USER=anvil
      - ANVIL_DATABASE_PASSWORD=anvil
      - ANVIL_DATABASE_DATABASE=anvil
      - ANVIL_REDIS_HOST=redis
      - ANVIL_REDIS_PORT=6379
      - ANVIL_SERVER_PORT=8080
      - ANVIL_JWT_SECRET=dev-secret-change-in-production
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # For container management
      - /root/.ssh:/root/.ssh:ro  # SSH key for VM host access
      - ./data/storage:/var/lib/anvil/storage  # Shared storage
      - /var/lib/anvil:/var/lib/anvil  # VM templates and storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - anvil-internal
      - anvil-challenges
    restart: unless-stopped

  # Anvil Frontend (development)
  web:
    build:
      context: ./web
      dockerfile: ../deployments/docker/Dockerfile.web
      target: development
      args:
        PUBLIC_API_URL: http://localhost:8080  # Change for production
    container_name: anvil-web
    environment:
      - NODE_ENV=development
    ports:
      - "3000:3000"
    volumes:
      - ./web:/app
      - /app/node_modules
    depends_on:
      - api
    networks:
      - anvil-internal

networks:
  anvil-internal:
    driver: bridge
  anvil-challenges:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres_data:
  redis_data:
